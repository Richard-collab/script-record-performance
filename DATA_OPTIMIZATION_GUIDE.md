# 数据展示优化说明

## 📊 改进概述

本次优化修正了API字段映射错误，增强了数据展示的完整性和正确性。

## ✅ 主要修改

### 1. 修正API字段名称错误

#### 错误修正：
- **语料挂机率字段**：`key_corpus_hangup_rate` → `key_corpus_hangup_rate_1`
- **A类通话时长字段**：`a_class_average_duration` → `A_class_avg_duration`

这些是实际API返回的正确字段名称。

### 2. 新增数据指标

在原有核心指标基础上，增加了以下维度的数据展示：

#### 核心指标新增：
- **沉默挂机率** (silence_hangup_rate)
  - 显示客户沉默导致的挂机比率
  - 帮助评估话术的互动性

#### 新增数据组：
- **知识库命中率详情** (key_knowledge_base_hit_rate)
  - 展示知识库中各问答类型的命中情况
  - 包含：问答-拒绝、问答-询问额度、问答-还款相关等
  
- **意图命中率详情** (key_intention_hit_rate)
  - 展示用户意图识别情况
  - 分类：A、B、D、AB、ABC、ABCD等级别

### 3. 优化数据格式化逻辑

#### 差值方向优化：
对于不同类型的指标，调整了差值方向的判断逻辑：

| 指标类型 | 增加时方向 | 业务含义 |
|---------|-----------|----------|
| 外呼量/接通量 | ↑ (绿色) | 数量增加是好事 |
| 通话时长 | ↑ (绿色) | 时长增加说明客户更感兴趣 |
| **挂机率** | ↓ (红色) | 挂机率增加是坏事 |
| 命中率 | ↑ (绿色) | 命中率增加是好事 |

#### 特别处理的指标：
- 开场白挂机率
- 沉默挂机率
- 所有语料挂机率子项

这些指标降低时显示为"up"(绿色)，表示性能改善。

### 4. 改进数据解析

#### 优化Python字典解析：
```typescript
// 改进前：无法正确解析中文键
const matches = hitRateStr.matchAll(/['"]?(\w+)['"]?\s*:\s*([\d.]+)/g);

// 改进后：支持中文和特殊字符
const jsonStr = hitRateStr.replace(/'/g, '"');
return JSON.parse(jsonStr);
// 备用方案：
const pattern = /['"]([^'"]+)['"]\s*:\s*([\d.]+)/g;
```

现在能够正确解析如下格式的数据：
```python
{'问候语': 0.9999, '开场白': 0.8105, '引导打开微信搜索框1': 0.0543}
```

## 🧪 测试验证

### 完整数据流程测试结果：

```
✅ API调用成功 - 获取到39个脚本
✅ 数据获取成功 - 基准组13条任务，实验组9条任务
✅ 数据对比正常 - 6个核心指标全部显示
✅ 语料解析正常 - 中文键正确识别
✅ 语料命中率 - 显示5个主要语料项
✅ 语料挂机率 - 显示5个主要语料项
```

### 核心指标对比示例：
```
外呼量:           214,183 → 68,699 (-145,484)
接通量:           7,494 → 2,393 (-5,101)
开场白挂机率:     72.52% → 73.85% (+1.34%)
平均通话时长:     18.29s → 18.21s (-0.08s)
A类平均通话时长:  229.52s → 246.31s (+16.79s)
沉默挂机率:       6.16% → 7.60% (+1.44%)
```

### 语料命中率对比示例：
```
问候语              99.99% → 99.96% (-0.03%)
开场白              81.05% → 85.63% (+4.58%)
引导打开微信搜索框1   5.43% → 4.09% (-1.34%)
```

## 📁 修改的文件

1. **src/utils/api.ts**
   - 修正字段名称映射
   - 新增数据指标解析
   - 优化parseKeyCorpusHitRate函数
   - 调整差值方向判断逻辑
   - 添加知识库和意图命中率支持

## 🚀 使用方法

1. 启动开发服务器：
   ```bash
   bun run dev
   ```

2. 在浏览器中打开 http://localhost:5174/

3. 在左侧筛选面板：
   - 选择分析日期
   - 选择基准话术 (A) 和任务
   - 选择实验话术 (B) 和任务
   - 点击"开始分析"

4. 右侧看板将显示：
   - A/B 测试核心数据（6个指标）
   - 重点语料命中率详情
   - 重点语料挂机率详情
   - 知识库命中率详情（新增）
   - 意图命中率详情（新增）

## 📝 数据完整性保障

### 空值处理
所有指标都有空值保护，缺失数据显示为 `--`

### 容错机制
- API调用失败时显示错误提示
- 数据解析失败时fallback到手动解析
- 过滤空键避免显示无效数据

### 数值格式化
- 整数：千位分隔符（214,183）
- 百分比：保留2位小数（72.52%）
- 时长：保留2位小数（18.29s）
- 差值：带符号显示（+4.58%，-0.03%）

## 🎨 视觉优化

差值颜色：
- 🟢 绿色 (up)：性能提升
- 🔴 红色 (down)：性能下降  
- ⚪ 灰色 (neutral)：无变化

图标：
- 📊 BarChart - 核心数据
- 📑 Category - 详细分类数据

## 🔍 后续建议

1. 考虑添加数据导出功能
2. 考虑添加历史对比功能
3. 考虑添加数据可视化图表
4. 考虑添加自定义指标显示配置
5. 考虑添加 top_15_intention_hit_rate 的展示

---

**更新时间**: 2026-02-09  
**测试状态**: ✅ 全部通过
